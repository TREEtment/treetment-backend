name: Simple CI/CD to EC2 (Fast Build)

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Java 21 + Gradle 캐시로 JAR 빌드 (러너에서)
      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          cache: gradle

      - name: Build bootJar
        run: |
          ./gradlew --no-daemon clean bootJar
          # 가장 첫 번째 JAR을 app.jar로 표준화
          JAR=$(ls build/libs/*.jar | head -n 1)
          cp "$JAR" app.jar
          ls -lh app.jar

      # 업로드용 번들(tar.gz) 만들기: Dockerfile, compose, app.jar만 포함
      - name: Create deploy bundle
        run: |
          mkdir -p out/bundle
          cp -v app.jar out/bundle/
          cp -v Dockerfile docker-compose.yml out/bundle/
          tar -czf out/app.tar.gz -C out/bundle .
          ls -lh out/app.tar.gz

      # 원격 경로 준비
      - name: Prepare remote dirs
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}     # ex) ubuntu, ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e
            APP_HOME="/home/$USER/app/backend"
            UPLOAD_DIR="$APP_HOME/_upload"
            mkdir -p "$APP_HOME" "$UPLOAD_DIR"

      # 번들 업로드 (폴더 strip)
      - name: Upload tarball to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "out/app.tar.gz"
          target: "/home/${{ secrets.EC2_USER }}/app/backend/_upload"
          overwrite: true
          strip_components: 1
          debug: true

      # /tmp에 풀어 검증 → rsync로 반영 → Docker Compose up
      - name: Deploy on EC2
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          command_timeout: 30m
          script: |
            set -euo pipefail
            APP_HOME="/home/$USER/app/backend"
            UPLOAD_DIR="$APP_HOME/_upload"
            STAGE_DIR="/tmp/backend_stage_$(date +%s)"

            # 업로드 파일 확인
            if [ -f "$UPLOAD_DIR/out/app.tar.gz" ]; then
              mv "$UPLOAD_DIR/out/app.tar.gz" "$UPLOAD_DIR/app.tar.gz" || true
              rmdir "$UPLOAD_DIR/out" 2>/dev/null || true
            fi
            [ -f "$UPLOAD_DIR/app.tar.gz" ] || { echo "tar not found"; exit 1; }

            # Docker/Compose 없으면 설치(필요 시 1회)
            if ! command -v docker >/dev/null 2>&1; then
              sudo apt-get update -y
              sudo apt-get install -y ca-certificates curl gnupg lsb-release
              sudo install -m 0755 -d /etc/apt/keyrings
              curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
              echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(. /etc/os-release; echo $VERSION_CODENAME) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
              sudo apt-get update -y
              sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
              sudo usermod -aG docker $USER || true
              # Docker 서비스 시작 및 활성화
              sudo systemctl start docker
              sudo systemctl enable docker
            fi
            if docker compose version >/dev/null 2>&1; then
              DOCKER_COMPOSE="docker compose"
            else
              command -v docker-compose >/dev/null 2>&1 || sudo apt-get install -y docker-compose
              DOCKER_COMPOSE="docker-compose"
            fi

            # 스테이징 → 검증 → 반영
            mkdir -p "$STAGE_DIR"
            tar -xzf "$UPLOAD_DIR/app.tar.gz" -C "$STAGE_DIR"
            ls -la "$STAGE_DIR"
            [ -f "$STAGE_DIR/Dockerfile" ] && [ -f "$STAGE_DIR/docker-compose.yml" ] && [ -f "$STAGE_DIR/app.jar" ] || { echo "bundle content missing"; exit 1; }

            # rsync로 원자적 반영
            command -v rsync >/dev/null 2>&1 || sudo apt-get install -y rsync
            rsync -a --delete "$STAGE_DIR/." "$APP_HOME/"
            rm -rf "$STAGE_DIR" "$UPLOAD_DIR/app.tar.gz"

            # 빠른 빌드(이미 JAR 포함이므로 아주 가벼움)
            cd "$APP_HOME"
            
            # 80번 포트를 사용하는 모든 프로세스 확인 및 정리
            echo "Checking processes using port 80..."
            sudo netstat -tlnp | grep :80 || echo "No processes found on port 80"
            
            # 기존 Docker 컨테이너들 정리 (포트 충돌 방지)
            echo "Stopping all Docker containers using port 80..."
            docker ps -q --filter "publish=80" | xargs -r docker stop || true
            docker ps -aq --filter "publish=80" | xargs -r docker rm || true
            
            # Apache/Nginx 등이 실행 중이면 중지
            sudo systemctl stop apache2 2>/dev/null || true
            sudo systemctl stop nginx 2>/dev/null || true
            sudo systemctl stop httpd 2>/dev/null || true
            
            # Docker 권한 확인 및 컨테이너 실행
            if ! docker ps >/dev/null 2>&1; then
              echo "Docker permission issue, using sudo"
              sudo $DOCKER_COMPOSE down || true
              sudo $DOCKER_COMPOSE up -d --build
            else
              $DOCKER_COMPOSE down || true
              $DOCKER_COMPOSE up -d --build
            fi
            
            # 이미지 정리
            docker image prune -f || sudo docker image prune -f || true
            
            # 헬스 체크
            echo "Waiting for application to start..."
            sleep 15
            for i in {1..5}; do
              if curl -f http://localhost:80/actuator/health 2>/dev/null; then
                echo "Health check passed!"
                break
              else
                echo "Health check attempt $i failed, retrying..."
                sleep 5
              fi
            done

            echo "[OK] Deployed. Try: curl http://<EC2_PUBLIC_IP>/actuator/health"
