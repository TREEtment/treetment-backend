name: Deploy Backend (GHCR, backend-only, external appnet)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  packages: write   # GHCR push 권한

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/backend-backend

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect layout
        id: detect
        shell: bash
        run: |
          set -euo pipefail
          if [ -f "./backend/gradlew" ]; then
            echo "project_dir=backend" >> "$GITHUB_OUTPUT"
            echo "docker_context=./backend" >> "$GITHUB_OUTPUT"
            echo "gradle_prefix=" >> "$GITHUB_OUTPUT"
          elif [ -f "./gradlew" ] && grep -qE '^include\(.*"backend".*\)' settings.gradle settings.gradle.kts 2>/dev/null; then
            echo "project_dir=." >> "$GITHUB_OUTPUT"
            echo "docker_context=./backend" >> "$GITHUB_OUTPUT"
            echo "gradle_prefix=:backend:" >> "$GITHUB_OUTPUT"
          elif [ -f "./gradlew" ]; then
            echo "project_dir=." >> "$GITHUB_OUTPUT"
            echo "docker_context=." >> "$GITHUB_OUTPUT"
            echo "gradle_prefix=" >> "$GITHUB_OUTPUT"
          else
            echo "::error::gradlew not found"; exit 1
          fi

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          cache: gradle

      - name: Make gradlew executable
        shell: bash
        run: |
          chmod +x "${{ steps.detect.outputs.project_dir }}/gradlew" || true
          chmod +x ./gradlew || true

      - name: Build JAR (skip tests)
        shell: bash
        working-directory: ${{ steps.detect.outputs.project_dir }}
        run: |
          ./gradlew ${{ steps.detect.outputs.gradle_prefix }}clean ${{ steps.detect.outputs.gradle_prefix }}bootJar -x test
          ls -l build/libs || true
          sha256sum build/libs/*.jar || true

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Normalize image name (lowercase)
        id: imagename
        shell: bash
        run: |
          low=$(echo "${{ env.IMAGE_NAME }}" | tr '[:upper:]' '[:lower:]')
          echo "name=$low" >> "$GITHUB_OUTPUT"

      - name: Build and push image (GHCR)
        uses: docker/build-push-action@v6
        with:
          context: ${{ steps.detect.outputs.docker_context }}
          push: true
          tags: |
            ghcr.io/${{ steps.imagename.outputs.name }}:${{ github.sha }}
            ghcr.io/${{ steps.imagename.outputs.name }}:latest

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
      - name: Create docker-compose template (on runner)
        shell: bash
        run: |
          cat > compose.template.yml <<'TPL'
          # version 키는 제거(경고 제거). appnet은 미리 만들어 둔 external 네트워크를 그대로 사용.
          #   $ docker network create appnet    # 없으면 한 번만 실행

          networks:
            appnet:
              external: true

          services:
            backend:
              # GitHub Actions에서 커밋 SHA로 태그된 이미지를 참조
              # (도커허브 쓴다면: image: docker.io/<DOCKER_ID>/backend-backend:${GIT_SHA})
              image: __IMAGE__:__GIT_SHA__
              container_name: backend
              restart: always

              ports:
                - "80:8080"

              environment:
                # --- 기존에 쓰던 환경변수 그대로 유지 ---
                JASYPT_ENCRYPTOR_PASSWORD: ${JASYPT_ENCRYPTOR_PASSWORD}
                SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE:-prod}
                TZ: ${TZ:-Asia/Seoul}
                AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
                AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
                AWS_DEFAULT_REGION: ${AWS_DEFAULT_REGION:-ap-northeast-2}
                INTERNAL_SECRET: ${INTERNAL_SECRET}

                # --- DNS 캐시 안정화(간헐적 UnknownHost 완화) ---
                AI_IMAGE_URL: "http://image-model-api:8000"
                AI_TEXT_URL:  "http://text-model-api:8000"
                JAVA_OPTS: "-Dsun.net.inetaddr.ttl=5 -Dsun.net.inetaddr.negative.ttl=0"

              # 로컬 디버깅 시 host.docker.internal 해석 지원(서버에선 영향 없음)
              extra_hosts:
                - "host.docker.internal:host-gateway"

              networks:
                - appnet

              depends_on:
                - image-model-api
                - text-model-api

              # 헬스체크를 쓰면 롤링 재배포 안정성 ↑ (액추에이터 열려있을 때)
              # healthcheck:
              #   test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
              #   interval: 30s
              #   timeout: 5s
              #   retries: 3

            image-model-api:
              image: python:3.11-slim
              container_name: image-model-api
              restart: always
              ports:
                - "8100:8000"
              environment:
                OMP_NUM_THREADS: "1"
              working_dir: /app
              volumes:
                - /home/ubuntu/image-model:/app
              command: >
                sh -c "
                  set -e;
                  apt-get update && apt-get install -y --no-install-recommends 
                    libglib2.0-0 libsm6 libxext6 libxrender1 libgl1 libgomp1 &&
                  rm -rf /var/lib/apt/lists/* &&
                  pip install --no-cache-dir 'numpy<2.0,>=1.24' &&
                  pip install --no-cache-dir fastapi uvicorn[standard] pillow requests safetensors &&
                  pip install --no-cache-dir --index-url https://download.pytorch.org/whl/cpu 
                    torch==2.2.2+cpu torchvision==0.17.2+cpu &&
                  pip install --no-cache-dir transformers==4.40.2 &&
                  uvicorn image_api:app --host 0.0.0.0 --port 8000 --workers 1
                "
              networks:
                - appnet

            text-model-api:
              image: python:3.11-slim
              container_name: text-model-api
              restart: always
              ports:
                - "8000:8000"
              environment:
                OMP_NUM_THREADS: "1"
              working_dir: /app
              volumes:
                - /home/ubuntu/text-model:/app
              command: >
                sh -c "
                  set -e;
                  apt-get update && apt-get install -y --no-install-recommends libgomp1 &&
                  rm -rf /var/lib/apt/lists/* &&
                  pip install --no-cache-dir 'numpy<2' fastapi uvicorn[standard] requests pillow &&
                  pip install --no-cache-dir transformers==4.40.2 &&
                  pip install --no-cache-dir --index-url https://download.pytorch.org/whl/cpu torch==2.2.2+cpu &&
                  uvicorn api:app --host 0.0.0.0 --port 8000 --workers 1
                "
              networks:
                - appnet
          TPL
          IMAGE="ghcr.io/$(echo '${{ env.IMAGE_NAME }}' | tr '[:upper:]' '[:lower:]')"
          sed -e "s|__IMAGE__|${IMAGE}|g" -e "s|__GIT_SHA__|${{ github.sha }}|g" compose.template.yml > docker-compose.yml
          echo "---- Generated docker-compose.yml ----"
          cat docker-compose.yml

      - name: Upload docker-compose.yml to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "docker-compose.yml"
          target: "~"

      - name: Deploy via SSH (use external appnet)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script_stop: true
          script: |
            set -euo pipefail

            echo "Login GHCR..."
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin

            echo "Ensure external network (quiet if exists)..."
            docker network inspect appnet >/dev/null 2>&1 || docker network create appnet >/dev/null 2>&1

            echo "Inject .env (append/update keys you use)..."
            touch .env
            sed -i '/^AWS_ACCESS_KEY_ID=/d' .env || true
            sed -i '/^AWS_SECRET_ACCESS_KEY=/d' .env || true
            sed -i '/^JASYPT_ENCRYPTOR_PASSWORD=/d' .env || true
            sed -i '/^INTERNAL_SECRET=/d' .env || true
            echo "AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}" >> .env
            echo "AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}" >> .env
            echo "JASYPT_ENCRYPTOR_PASSWORD=${{ secrets.JASYPT_ENCRYPTOR_PASSWORD }}" >> .env
            echo "INTERNAL_SECRET=${{ secrets.INTERNAL_SECRET }}" >> .env

            echo "Cleanup old container..."
            docker compose -f docker-compose.yml down --remove-orphans >/dev/null 2>&1 || true
            docker rm -f backend >/dev/null 2>&1 || true
            docker ps -aq --filter "name=^/backend$" | xargs -r docker rm -f >/dev/null 2>&1 || true

            echo "Validate compose..."
            docker compose -f docker-compose.yml config >/dev/null

            echo "Pull & up..."
            docker compose -f docker-compose.yml pull || true
            docker compose -f docker-compose.yml up -d

            echo "PS:"
            docker ps --format 'table {{.Names}}\t{{.Image}}\t{{.Status}}\t{{.Ports}}'

            echo "Backend logs (tail 200):"
            docker logs --tail 200 backend || true