name: Simple CI/CD to EC2 (Fast Build)

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Java 21 + Gradle ìºì‹œë¡œ JAR ë¹Œë“œ (ëŸ¬ë„ˆì—ì„œ)
      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          cache: gradle

      - name: Build bootJar
        run: |
          chmod +x ./gradlew
          ./gradlew --no-daemon clean bootJar
          # ê°€ìž¥ ì²« ë²ˆì§¸ JARì„ app.jarë¡œ í‘œì¤€í™”
          JAR=$(ls build/libs/*.jar | head -n 1)
          cp "$JAR" app.jar
          ls -lh app.jar

      # ì—…ë¡œë“œìš© ë²ˆë“¤(tar.gz) ë§Œë“¤ê¸°: Dockerfile, compose, app.jarë§Œ í¬í•¨
      - name: Create deploy bundle
        run: |
          mkdir -p out/bundle
          cp -v app.jar out/bundle/
          cp -v Dockerfile docker-compose.yml out/bundle/
          tar -czf out/app.tar.gz -C out/bundle .
          ls -lh out/app.tar.gz

      # ì›ê²© ê²½ë¡œ ì¤€ë¹„
      - name: Prepare remote dirs
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}     # ex) ubuntu, ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e
            APP_HOME="/home/$USER/app/backend"
            UPLOAD_DIR="$APP_HOME/_upload"
            mkdir -p "$APP_HOME" "$UPLOAD_DIR"

      # ë²ˆë“¤ ì—…ë¡œë“œ (í´ë” strip)
      - name: Upload tarball to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "out/app.tar.gz"
          target: "/home/${{ secrets.EC2_USER }}/app/backend/_upload"
          overwrite: true
          strip_components: 1
          debug: true

      # /tmpì— í’€ì–´ ê²€ì¦ â†’ rsyncë¡œ ë°˜ì˜ â†’ Docker Compose up
      # GitHub Secretì„ ì›ê²©ì— ì•ˆì „í•˜ê²Œ ì „ë‹¬(.env ìƒì„±)í•˜ê¸° ìœ„í•´ envs ì‚¬ìš©
      - name: Deploy on EC2
        uses: appleboy/ssh-action@v1.2.0
        env:
          JASYPT_ENCRYPTOR_PASSWORD: ${{ secrets.JASYPT_ENCRYPTOR_PASSWORD }}
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          command_timeout: 30m
          # ì•„ëž˜ envsì— ë‚˜ì—´í•œ ë³€ìˆ˜ëª…ì´ ì›ê²© ì‰˜ì—ë„ ì „ë‹¬ë©ë‹ˆë‹¤.
          envs: JASYPT_ENCRYPTOR_PASSWORD
          script: |
            set -euo pipefail
            APP_HOME="/home/$USER/app/backend"
            UPLOAD_DIR="$APP_HOME/_upload"
            STAGE_DIR="/tmp/backend_stage_$(date +%s)"

            # ì—…ë¡œë“œ íŒŒì¼ í™•ì¸
            if [ -f "$UPLOAD_DIR/out/app.tar.gz" ]; then
              mv "$UPLOAD_DIR/out/app.tar.gz" "$UPLOAD_DIR/app.tar.gz" || true
              rmdir "$UPLOAD_DIR/out" 2>/dev/null || true
            fi
            [ -f "$UPLOAD_DIR/app.tar.gz" ] || { echo "tar not found"; exit 1; }

            # Docker/Compose ì—†ìœ¼ë©´ ì„¤ì¹˜(í•„ìš” ì‹œ 1íšŒ)
            if ! command -v docker >/dev/null 2>&1; then
              sudo apt-get update -y
              sudo apt-get install -y ca-certificates curl gnupg lsb-release
              sudo install -m 0755 -d /etc/apt/keyrings
              curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
              echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(. /etc/os-release; echo $VERSION_CODENAME) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
              sudo apt-get update -y
              sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
              sudo usermod -aG docker $USER || true
              sudo systemctl start docker
              sudo systemctl enable docker
            fi
            if docker compose version >/dev/null 2>&1; then
              DOCKER_COMPOSE="docker compose"
            else
              command -v docker-compose >/dev/null 2>&1 || sudo apt-get install -y docker-compose
              DOCKER_COMPOSE="docker-compose"
            fi

            # ìŠ¤í…Œì´ì§• â†’ ê²€ì¦ â†’ ë°˜ì˜
            mkdir -p "$STAGE_DIR"
            tar -xzf "$UPLOAD_DIR/app.tar.gz" -C "$STAGE_DIR"
            ls -la "$STAGE_DIR"
            [ -f "$STAGE_DIR/Dockerfile" ] && [ -f "$STAGE_DIR/docker-compose.yml" ] && [ -f "$STAGE_DIR/app.jar" ] || { echo "bundle content missing"; exit 1; }

            # rsyncë¡œ ì›ìžì  ë°˜ì˜
            command -v rsync >/dev/null 2>&1 || sudo apt-get install -y rsync
            rsync -a --delete "$STAGE_DIR/." "$APP_HOME/"
            rm -rf "$STAGE_DIR" "$UPLOAD_DIR/app.tar.gz"

            cd "$APP_HOME"

            # ====== ðŸ” Secrets ì£¼ìž…: .env ìƒì„± ======
            # docker composeëŠ” ê¸°ë³¸ì ìœ¼ë¡œ í˜„ìž¬ í´ë”ì˜ .envë¥¼ ì½ì§€ë§Œ,
            # ëª…ì‹œì ìœ¼ë¡œ --env-fileë„ ì‚¬ìš©í•´ ì•ˆì „í•˜ê²Œ ì£¼ìž…í•©ë‹ˆë‹¤.
            printf "JASYPT_ENCRYPTOR_PASSWORD=%s\n" "$JASYPT_ENCRYPTOR_PASSWORD" > "$APP_HOME/.env"
            chmod 600 "$APP_HOME/.env"

            # 80ë²ˆ í¬íŠ¸ë¥¼ ì‚¬ìš©í•˜ëŠ” ëª¨ë“  í”„ë¡œì„¸ìŠ¤ í™•ì¸ ë° ì •ë¦¬
            echo "Checking processes using port 80..."
            sudo netstat -tlnp | grep :80 || echo "No processes found on port 80"

            # ê¸°ì¡´ Docker ì»¨í…Œì´ë„ˆë“¤ ì •ë¦¬ (í¬íŠ¸ ì¶©ëŒ ë°©ì§€)
            echo "Stopping all Docker containers using port 80..."
            docker ps -q --filter "publish=80" | xargs -r docker stop || true
            docker ps -aq --filter "publish=80" | xargs -r docker rm || true

            # Apache/Nginx ë“±ì´ ì‹¤í–‰ ì¤‘ì´ë©´ ì¤‘ì§€
            sudo systemctl stop apache2 2>/dev/null || true
            sudo systemctl stop nginx 2>/dev/null || true
            sudo systemctl stop httpd 2>/dev/null || true

            # Docker ê¶Œí•œ í™•ì¸ ë° ì»¨í…Œì´ë„ˆ ì‹¤í–‰
            if ! docker ps >/dev/null 2>&1; then
              echo "Docker permission issue, using sudo"
              sudo $DOCKER_COMPOSE --env-file "$APP_HOME/.env" down || true
              sudo $DOCKER_COMPOSE --env-file "$APP_HOME/.env" up -d --build
            else
              $DOCKER_COMPOSE --env-file "$APP_HOME/.env" down || true
              $DOCKER_COMPOSE --env-file "$APP_HOME/.env" up -d --build
            fi

            # ì´ë¯¸ì§€ ì •ë¦¬
            docker image prune -f || sudo docker image prune -f || true

            # í—¬ìŠ¤ ì²´í¬
            echo "Waiting for application to start..."
            sleep 15
            for i in {1..5}; do
              if curl -f http://localhost:80/actuator/health 2>/dev/null; then
                echo "Health check passed!"
                break
              else
                echo "Health check attempt $i failed, retrying..."
                sleep 5
              fi
            done

            echo "[OK] Deployed. Try: curl http://<EC2_PUBLIC_IP>/actuator/health"
