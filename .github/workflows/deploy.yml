name: Simple CI/CD to EC2 (Fast Build)

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Java 21 + Gradle ìºì‹œë¡œ JAR ë¹Œë“œ (ëŸ¬ë„ˆì—ì„œ)
      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          cache: gradle

      - name: Build bootJar
        run: |
          chmod +x ./gradlew
          ./gradlew --no-daemon clean bootJar
          # ê°€ì¥ ì²« ë²ˆì§¸ JARì„ app.jarë¡œ í‘œì¤€í™”
          JAR=$(ls build/libs/*.jar | head -n 1)
          cp "$JAR" app.jar
          ls -lh app.jar

      # ì—…ë¡œë“œìš© ë²ˆë“¤(tar.gz) ë§Œë“¤ê¸°: Dockerfile, compose, app.jarë§Œ í¬í•¨
      - name: Create deploy bundle
        run: |
          mkdir -p out/bundle
          cp -v app.jar out/bundle/
          cp -v Dockerfile docker-compose.yml out/bundle/
          cp -v worker.sh out/bundle/
          tar -czf out/app.tar.gz -C out/bundle .
          ls -lh out/app.tar.gz

      # ì›ê²© ê²½ë¡œ ì¤€ë¹„
      - name: Prepare remote dirs
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}     # ex) ubuntu, ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e
            APP_HOME="/home/$USER/app/backend"
            UPLOAD_DIR="$APP_HOME/_upload"
            mkdir -p "$APP_HOME" "$UPLOAD_DIR"

      # ë²ˆë“¤ ì—…ë¡œë“œ (í´ë” strip)
      - name: Upload tarball to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "out/app.tar.gz"
          target: "/home/${{ secrets.EC2_USER }}/app/backend/_upload"
          overwrite: true
          strip_components: 1
          debug: true

      # /tmpì— í’€ì–´ ê²€ì¦ â†’ rsyncë¡œ ë°˜ì˜ â†’ Docker Compose up
      # GitHub Secretì„ ì›ê²©ì— ì•ˆì „í•˜ê²Œ ì „ë‹¬(.env ìƒì„±)í•˜ê¸° ìœ„í•´ envs ì‚¬ìš©
      - name: Deploy on EC2
        uses: appleboy/ssh-action@v1.2.0
        env:
          # GitHub Secrets â†’ ëŸ°ë„ˆ í™˜ê²½ë³€ìˆ˜
          JASYPT_ENCRYPTOR_PASSWORD: ${{ secrets.JASYPT_ENCRYPTOR_PASSWORD }}
          # (ì„ íƒ) í•­ìƒ prod í”„ë¡œí•„/ì„œìš¸ TZ ê³ ì •í•˜ê³  ì‹¶ë‹¤ë©´ ì—¬ê¸°ë„ ì¶”ê°€ ê°€ëŠ¥
          SPRING_PROFILES_ACTIVE: prod
          TZ: Asia/Seoul
          AWS_ACCESS_KEY_ID: ${{ secrets.GPU_AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.GPU_AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ap-northeast-2
          INTERNAL_SECRET: ${{ secrets.INTERNAL_SECRET }}
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          command_timeout: 30m
          # â˜… ì´ ì¤„ì´ 'ì›ê²©'ìœ¼ë¡œ ë„˜ê¸°ëŠ” í‚¤: ì—¬ê¸° ë‚˜ì—´ ì•ˆ í•˜ë©´ ì›ê²© ì‰˜ì—ì„œ ëª» ì”€
          envs: JASYPT_ENCRYPTOR_PASSWORD,SPRING_PROFILES_ACTIVE,TZ,AWS_ACCESS_KEY_ID,AWS_SECRET_ACCESS_KEY,AWS_DEFAULT_REGION,INTERNAL_SECRET
          script: |
            set -Eeuo pipefail

            APP_HOME="/home/$USER/app/backend"
            UPLOAD_DIR="$APP_HOME/_upload"
            STAGE_DIR="/tmp/backend_stage_$(date +%s)"

            # ì—…ë¡œë“œ íŒŒì¼ í™•ì¸
            if [ -f "$UPLOAD_DIR/out/app.tar.gz" ]; then
              mv "$UPLOAD_DIR/out/app.tar.gz" "$UPLOAD_DIR/app.tar.gz" || true
              rmdir "$UPLOAD_DIR/out" 2>/dev/null || true
            fi
            [ -f "$UPLOAD_DIR/app.tar.gz" ] || { echo "tar not found"; exit 1; }

            # Docker/Compose ì„¤ì¹˜ (í•„ìš” ì‹œ 1íšŒ)
            if ! command -v docker >/dev/null 2>&1; then
              sudo apt-get update -y
              sudo apt-get install -y ca-certificates curl gnupg lsb-release
              sudo install -m 0755 -d /etc/apt/keyrings
              curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
              echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(. /etc/os-release; echo $VERSION_CODENAME) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
              sudo apt-get update -y
              sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
              sudo usermod -aG docker $USER || true
              sudo systemctl enable --now docker
            fi
            if docker compose version >/dev/null 2>&1; then
              DOCKER_COMPOSE="docker compose"
            else
              command -v docker-compose >/dev/null 2>&1 || sudo apt-get install -y docker-compose
              DOCKER_COMPOSE="docker-compose"
            fi

            # ìŠ¤í…Œì´ì§• â†’ ê²€ì¦ â†’ ë°˜ì˜
            mkdir -p "$STAGE_DIR"
            tar -xzf "$UPLOAD_DIR/app.tar.gz" -C "$STAGE_DIR"
            ls -la "$STAGE_DIR"
            [ -f "$STAGE_DIR/Dockerfile" ] && [ -f "$STAGE_DIR/docker-compose.yml" ] && [ -f "$STAGE_DIR/app.jar" ] || { echo "bundle content missing"; exit 1; }

            command -v rsync >/dev/null 2>&1 || sudo apt-get install -y rsync
            mkdir -p "$APP_HOME"
            rsync -a --delete "$STAGE_DIR/." "$APP_HOME/"
            rm -rf "$STAGE_DIR" "$UPLOAD_DIR/app.tar.gz"

            cd "$APP_HOME"

            # ====== ğŸ” Secrets ì£¼ì…: .env ìƒì„± (base64 ê²½ìœ ) ======
            # â˜… íŠ¹ìˆ˜ë¬¸ì/ê°œí–‰ ê¹¨ì§ ë°©ì§€
            if [ -z "${JASYPT_ENCRYPTOR_PASSWORD:-}" ]; then
              echo "[FATAL] JASYPT_ENCRYPTOR_PASSWORD is empty from GitHub Secrets or not passed via 'envs:'"; exit 1
            fi
            SECRET_B64="$(printf '%s' "$JASYPT_ENCRYPTOR_PASSWORD" | base64 -w0 2>/dev/null || printf '%s' "$JASYPT_ENCRYPTOR_PASSWORD" | base64)"
            {
              echo "JASYPT_ENCRYPTOR_PASSWORD=$(printf '%s' "$SECRET_B64" | base64 -d)"
              # (ì„ íƒ) í•¨ê»˜ ê³ ì •í•˜ê³  ì‹¶ìœ¼ë©´ ì—¬ê¸°ë„ ê¸°ë¡
              echo "SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-prod}"
              echo "TZ=${TZ:-Asia/Seoul}"
              echo "AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}"
              echo "AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}"
              echo "AWS_DEFAULT_REGION=${AWS_DEFAULT_REGION:-ap-northeast-2}"
              echo "INTERNAL_SECRET=${INTERNAL_SECRET}"
            } > "$APP_HOME/.env"
            chmod 600 "$APP_HOME/.env"

            # â˜… ê°’ ë§ˆìŠ¤í‚¹í•˜ì—¬ ì¡´ì¬ë§Œ í™•ì¸
            awk -F= '{print $1"="(length($2)?"***":"<empty>")}' "$APP_HOME/.env"

            # í¬íŠ¸ 80 ì‚¬ìš© í”„ë¡œì„¸ìŠ¤ ì •ë¦¬
            echo "Checking processes using port 80..."
            sudo netstat -tlnp | grep :80 || echo "No processes found on port 80"
            echo "Stopping all Docker containers using port 80..."
            docker ps -q --filter "publish=80" | xargs -r docker stop || true
            docker ps -aq --filter "publish=80" | xargs -r docker rm || true
            sudo systemctl stop apache2 2>/dev/null || true
            sudo systemctl stop nginx 2>/dev/null || true
            sudo systemctl stop httpd 2>/dev/null || true

            # Compose up
            if ! docker ps >/dev/null 2>&1; then
              echo "Docker permission issue, using sudo"
              sudo $DOCKER_COMPOSE --env-file "$APP_HOME/.env" down || true
              sudo $DOCKER_COMPOSE --env-file "$APP_HOME/.env" up -d --build
            else
              $DOCKER_COMPOSE --env-file "$APP_HOME/.env" down || true
              $DOCKER_COMPOSE --env-file "$APP_HOME/.env" up -d --build
            fi

            # ì´ë¯¸ì§€ ì •ë¦¬
            docker image prune -f || sudo docker image prune -f || true

            # í—¬ìŠ¤ ì²´í¬
            echo "Waiting for application to start..."
            sleep 15
            for i in {1..5}; do
              if curl -fsS http://localhost:80/actuator/health >/dev/null 2>&1; then
                echo "Health check passed!"
                break
              else
                echo "Health check attempt $i failed, retrying..."
                sleep 5
              fi
            done

            echo "[OK] Deployed. Try: curl http://<EC2_PUBLIC_IP>/actuator/health"
      
